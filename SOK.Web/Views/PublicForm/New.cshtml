@model NewSubmissionWebFormVM

@{
    ViewData["Title"] = "Zgłoszenie kolędy";
    Layout = "_LayoutPublic";
}
<div id="public-form-app" class="w-full max-w-3xl">
    <!-- Nagłówek z informacjami o parafii -->
    <div class="bg-base-300 rounded-lg p-6 mb-6 shadow-md text-center text-lg">
        <h3 class="opacity-70">Formularz zgłoszeniowy</h3>
        <h1 class="text-4xl font-extrabold font-nunito-sans mb-2">@Model.Schedule.Name</h1>
        
        <h3 class="opacity-80">@Model.Parish.Name</h3>
    </div>

    <!-- Alert dla komunikatów -->
    <div v-if="message.show" 
            :class="['alert mb-6 shadow-lg', message.type === 'success' ? 'alert-success' : 'alert-error']"
            role="alert">
        <span>{{ message.text }}</span>
        <button class="btn btn-sm btn-circle btn-ghost hover:bg-current/50 hover:border-current/50 hover:text-base-100 justify-self-end" v-on:click="message.show = false"><i class="bi bi-x text-xl"></i></button>
    </div>

    <!-- Formularz -->
    <form asp-action="New" method="post" class="bg-base-200 rounded-lg p-6 shadow-md" v-on:submit="handleSubmit">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Validation Summary -->
            <div asp-validation-summary="ModelOnly" class="md:col-span-2 text-center text-error"></div>

            <!-- Imię -->
            <div class="form-control">
                <label class="label">
                    <span class="font-semibold">@Html.DisplayNameFor(m => m.Name) <span class="text-error">*</span></span>
                </label>
                <input asp-for="Name" 
                        v-model="form.name"
                        type="text" 
                        placeholder="Wpisz swoje imię"
                        class="input input-lg w-full focus:input-primary"
                        required />
                <span asp-validation-for="Name" class="text-error mt-1"></span>
            </div>

            <!-- Nazwisko -->
            <div class="form-control">
                <label class="label">
                    <span class="font-semibold">@Html.DisplayNameFor(m => m.Surname) <span class="text-error">*</span></span>
                </label>
                <input asp-for="Surname" 
                        v-model="form.surname"
                        type="text" 
                        placeholder="Wpisz swoje nazwisko"
                        class="input input-lg w-full focus:input-primary"
                        required />
                <span asp-validation-for="Surname" class="text-error mt-1"></span>
            </div>

            <!-- Ulica -->
            <div class="form-control">
                <label class="label">
                    <span class="font-semibold">@Html.DisplayNameFor(m => m.StreetId) <span class="text-error">*</span></span>
                </label>
                <select asp-for="StreetId" 
                        v-model="form.streetId"
                        asp-items="@Model.StreetList"
                        v-on:change="onStreetChange"
                        class="select select-lg w-full focus:select-primary"
                        required>
                    <option value="0" selected disabled>-- Wybierz ulicę --</option>
                </select>
                <span asp-validation-for="StreetId" class="text-error mt-1"></span>
            </div>

            <!-- Brama -->
            <div class="form-control">
                <label class="label">
                    <span class="font-semibold">@Html.DisplayNameFor(m => m.BuildingId) <span class="text-error">*</span></span>
                </label>
                <select asp-for="BuildingId" 
                        asp-items="@(Model.BuildingList.ContainsKey(Model.StreetId) ? Model.BuildingList[Model.StreetId] : new List<SelectListItem>())"
                        v-model="form.buildingId"
                        :disabled="!form.streetId"
                        class="select select-lg w-full focus:select-primary"
                        required>
                    <option value="0" selected disabled>-- Wybierz bramę --</option>
                </select>
                <span asp-validation-for="BuildingId" class="text-error mt-1"></span>
            </div>

            <!-- Numer mieszkania -->
            <div class="form-control md:col-span-2">
                <label class="label">
                    <span class="font-semibold">@Html.DisplayNameFor(m => m.Apartment) <span class="text-error">*</span></span>
                </label>
                <input asp-for="Apartment" 
                        v-model="form.apartment"
                        type="text" 
                        placeholder="np. 12 lub 12a"
                        class="input input-lg w-full focus:input-primary"
                        pattern="[0-9]{1,3}[a-zA-Z]{0,3}"
                        required />
                <span asp-validation-for="Apartment" class="text-error mt-1"></span>
            </div>

            <div class="divider md:col-span-2 my-2"></div>

            <!-- Checkbox - powiadomienia email -->
            <div class="form-control md:col-span-2">
                <label class="label cursor-pointer flex justify-start gap-3">
                    <input asp-for="WantsEmailNotification"
                            v-model="form.wantsEmail"
                            type="checkbox" 
                            class="checkbox checkbox-primary" />
                    <h5 class="font-semibold">@Html.DisplayNameFor(m => m.WantsEmailNotification)</h5>
                </label>
            </div>

            <!-- Email (pokazuje się warunkowo) -->
            <div v-show="form.wantsEmail" class="form-control md:col-span-2">
                <label class="label">
                    <span class="font-semibold">@Html.DisplayNameFor(m => m.Email) <span class="text-error">*</span></span>
                </label>
                <input asp-for="Email" 
                        v-model="form.email"
                        type="email" 
                        placeholder="twoj@email.pl"
                        class="input input-lg w-full focus:input-primary"
                        :required="form.wantsEmail" />
                <span asp-validation-for="Email" class="text-error mt-1"></span>
            </div>

            <!-- Checkbox - dodatkowe uwagi -->
            <div class="form-control md:col-span-2">
                <label class="label cursor-pointer flex justify-start gap-3">
                    <input asp-for="HasAdditionalNotes"
                            v-model="form.hasNotes"
                            type="checkbox" 
                            class="checkbox checkbox-primary" />
                    <h5 class="font-semibold">@Html.DisplayNameFor(m => m.HasAdditionalNotes)</h5>
                </label>
            </div>

            <!-- Dodatkowe uwagi (pokazuje się warunkowo) -->
            <div v-show="form.hasNotes" class="form-control md:col-span-2">
                <label class="label">
                    <span class="font-semibold">@Html.DisplayNameFor(m => m.SubmitterNotes)</span>
                </label>
                <textarea asp-for="SubmitterNotes" 
                            v-model="form.notes"
                            placeholder="Wpisz swoje uwagi..."
                            class="textarea textarea-lg w-full focus:textarea-primary h-24"
                            maxlength="500"></textarea>
                <label class="label">
                    <span class="opacity-50">{{ form.notes?.length || 0 }} / 500</span>
                </label>
                <span asp-validation-for="SubmitterNotes" class="text-error mt-1"></span>
            </div>

            <div class="divider md:col-span-2 my-2"></div>

            <!-- RODO Checkbox -->
            <div class="form-control md:col-span-2">
                <label class="hidden label cursor-pointer justify-start gap-3 items-start max-w-full">
                    <input asp-for="GdprConsent"
                            v-model="form.gdprConsent"
                            type="checkbox" 
                            class="checkbox checkbox-primary mt-1"
                            required />
                    <div class="flex flex-col">
                        <h5 class="font-semibold">Wyrażam zgodę na przetwarzanie danych osobowych <span class="text-error">*</span></h5>
                        <p class="text-sm opacity-70 mt-1">
                            Administratorem danych osobowych jest @Model.Parish.Name. 
                            Twoje dane będą wykorzystane wyłącznie w celu zorganizowania wizyty duszpasterskiej.
                        </p>
                    </div>
                </label>
                <div class="flex flex-col">
                    <h5 class="font-semibold">Wysyłając formularz wyrażasz zgodę na przetwarzanie danych osobowych.</h5>
                    <p class="text-sm opacity-70 mt-1">
                        Administratorem danych osobowych jest @Model.Parish.Name. 
                        Twoje dane będą wykorzystane wyłącznie w celu zorganizowania wizyty duszpasterskiej.
                    </p>
                </div>
                <span asp-validation-for="GdprConsent" class="text-error mt-1"></span>
            </div>

            <!-- Przycisk wysyłania -->
            <div class="md:col-span-2 mt-4">
                <button type="submit" 
                        class="btn btn-primary btn-lg w-full"
                        :disabled="isSubmitting || !isFormValid">
                    <span v-if="!isSubmitting">Wyślij zgłoszenie</span>
                    <span v-else class="loading loading-spinner"></span>
                </button>
            </div>
        </div>
    </form>

    <!-- Stopka z kontaktem -->
    <div class="mt-6 text-center text-sm opacity-70">
        <p class="font-medium mb-2">W razie pytań skontaktuj się z nami:</p>
        <p>
            @if (!string.IsNullOrEmpty(Model.Parish.Email))
            {
                <a href="mailto:@Model.Parish.Email" class="hover:underline hover:text-primary transition-colors">
                    <i class="bi bi-envelope-at-fill mr-1"></i> @Model.Parish.Email
                </a>
            }
            @if (!string.IsNullOrEmpty(Model.Parish.Phone))
            {
                <a href="tel:@Model.Parish.Phone" class="hover:underline hover:text-primary transition-colors ml-4">
                    <i class="bi bi-telephone-fill mr-1"></i> @Model.Parish.Phone
                </a>
            }
        </p>
        <p class="mt-2">@Model.Parish.StreetAndBuilding, @Model.Parish.PostalCode @Model.Parish.CityName</p>
    </div>
</div>

@section Scripts {    
    <partial name="_ValidationScriptsPartial" />
    <partial name="_VueScript" />

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    form: {
                        name: '@Html.Raw(Model.Name)',
                        surname: '@Html.Raw(Model.Surname)',
                        streetId: '@Html.Raw(Model.StreetId)',
                        buildingId: '@Html.Raw(Model.BuildingId)',
                        apartment: '@Html.Raw(Model.Apartment)',
                        wantsEmail: @(Model.WantsEmailNotification ? "true" : "false"),
                        email: '@Html.Raw(Model.Email)',
                        hasNotes: @(Model.HasAdditionalNotes ? "true" : "false"),
                        notes: '@Html.Raw(Model.SubmitterNotes)',
                        gdprConsent: true
                    },
                    buildingList: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.BuildingList)),
                    isSubmitting: false,
                    message: {
                        show: false,
                        type: 'success',
                        text: ''
                    }
                }
            },
            computed: {
                availableBuildings() {
                    if (!this.form.streetId) return [];
                    return this.buildingList[this.form.streetId] || [];
                },
                isFormValid() {
                    const basicValid = this.form.name && this.form.surname && 
                                    this.form.streetId > 0 && this.form.buildingId > 0 && 
                                    this.form.apartment && this.form.gdprConsent;
                    
                    if (this.form.wantsEmail && !this.form.email) {
                        return false;
                    }
                    
                    return basicValid;
                }
            },
            methods: {
                onStreetChange() {
                    this.form.buildingId = '0';
                },
                handleSubmit(event) {
                    if (!this.isFormValid) {
                        event.preventDefault();
                        this.showMessage('error', 'Wypełnij wszystkie wymagane pola formularza.');
                        return false;
                    }
                    
                    this.isSubmitting = true;
                    // Formularz zostanie wysłany normalnie przez MVC
                    return true;
                },
                showMessage(type, text) {
                    this.message = {
                        show: true,
                        type: type,
                        text: text
                    };
                }
            },
            mounted() {
                // Sprawdź czy jest komunikat z TempData
                const successMessage = '@Html.Raw(TempData["success"])';
                const errorMessage = '@Html.Raw(TempData["error"])';
                
                if (successMessage) {
                    this.showMessage('success', successMessage);
                } else if (errorMessage) {
                    this.showMessage('error', errorMessage);
                }

                // Zarejestruj dynamiczny wybór bramy
                const streetSelect = document.getElementById("StreetId");
                const buildingSelect = document.getElementById("BuildingId");

                registerBuildingPicker(streetSelect, buildingSelect, this.buildingList);
                registerVueApp('public-form-app');
            }
        }).mount('#public-form-app');
    </script>
}