@model CreateUserVM
@using SOK.Domain.Enums
@using SOK.Application.Common.Helpers
@{
    ViewData["Title"] = "Utwórz użytkownika";
    var allRoles = ViewData["AllRoles"] as List<Role> ?? new List<Role>();
    allRoles.Remove(Role.SuperAdmin);

    string GetBadgeColorClass(Role role)
    {
        return role switch
        {
            Role.Administrator => "bg-red-500 border-red-500 text-white",
            Role.Priest => "bg-purple-500 border-purple-500 text-white",
            Role.SubmitSupport => "bg-blue-500 border-blue-500 text-white",
            Role.VisitSupport => "bg-green-500 border-green-500 text-white",
            Role.DefaultUser => "bg-gray-400 border-gray-400 text-white",
            _ => "bg-gray-300 border-gray-300"
        };
    }
}

<div id="create-user-app" class="min-h-full w-full flex flex-col items-center justify-center">
    <form asp-action="CreateUser" method="post" class="flex flex-col gap-x-3 gap-y-4 w-5/6">
        <!-- === Sekcja 1: Podstawowe dane === -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
            <div>
                <h2 class="text-xl font-semibold mb-1">Podstawowe informacje</h2>
                <p class="text-sm opacity-40">
                    Uzupełnij podstawowe dane nowego użytkownika, takie jak nazwa wyświetlana i login.
                </p>
            </div>
            <div class="flex flex-col gap-3">
                <label asp-for="DisplayName" class="w-full">
                    <span class="label font-medium mb-1">@Html.DisplayNameFor(m => m.DisplayName)</span>
                    <input asp-for="DisplayName" class="input input-lg w-full" placeholder="Np. ks. Jan Kowalski" />
                    <span asp-validation-for="DisplayName" class="text-error text-sm"></span>
                </label>
                
                <label asp-for="UserName" class="w-full">
                    <span class="label font-medium mb-1">@Html.DisplayNameFor(m => m.UserName)</span>
                    <input asp-for="UserName" class="input input-lg w-full" placeholder="Np. jan.kowalski" />
                    <span asp-validation-for="UserName" class="text-error text-sm"></span>
                </label>
            </div>
        </div>

        <div class="divider my-0 opacity-20"></div>

        <!-- === Sekcja 2: Kontakt === -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
            <div>
                <h2 class="text-xl font-semibold mb-1">Dane kontaktowe</h2>
                <p class="text-sm opacity-40">
                    Podaj adres email użytkownika. To pole jest opcjonalne.
                </p>
            </div>
            <div>
                <label asp-for="Email" class="w-full">
                    <span class="label font-medium mb-1">@Html.DisplayNameFor(m => m.Email)</span>
                    <input asp-for="Email" type="email" class="input input-lg w-full" placeholder="Np. jan.kowalski@parafia.pl" />
                    <span asp-validation-for="Email" class="text-error text-sm"></span>
                </label>
            </div>
        </div>

        <div class="divider my-0 opacity-20"></div>

        <!-- === Sekcja 3: Hasło === -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
            <div>
                <h2 class="text-xl font-semibold mb-1">Ustaw hasło</h2>
                <p class="text-sm opacity-40">
                    Określ hasło dla nowego użytkownika. Musi mieć co najmniej 6 znaków. Możesz wygenerować losowe hasło.
                </p>
            </div>
            <div class="flex flex-col gap-3">
                <div class="flex gap-2">
                    <label asp-for="Password" class="flex-1">
                        <span class="label font-medium mb-1">@Html.DisplayNameFor(m => m.Password)</span>
                        <input asp-for="Password" type="password" class="input input-lg w-full" v-model="password" />
                        <span asp-validation-for="Password" class="text-error text-sm"></span>
                    </label>
                    <div class="flex flex-col justify-end">
                        <button type="button" 
                                v-on:click="generatePassword" 
                                class="btn btn-secondary">
                            <i class="bi bi-key"></i> Generuj
                        </button>
                    </div>
                </div>
                
                <label asp-for="ConfirmPassword" class="w-full">
                    <span class="label font-medium mb-1">@Html.DisplayNameFor(m => m.ConfirmPassword)</span>
                    <input asp-for="ConfirmPassword" type="password" class="input input-lg w-full" v-model="confirmPassword" />
                    <span asp-validation-for="ConfirmPassword" class="text-error text-sm"></span>
                </label>
                
                <div v-if="generatedPassword" class="p-3 bg-info/20 rounded-lg">
                    <p class="text-sm font-semibold mb-2">Wygenerowane hasło:</p>
                    <div class="flex gap-2 items-center">
                        <code class="flex-1 p-2 bg-base-200 rounded font-mono text-sm">{{ generatedPassword }}</code>
                        <button type="button" 
                                v-on:click="copyGeneratedPassword" 
                                class="btn btn-sm btn-primary">
                            <i class="bi bi-clipboard"></i> Kopiuj
                        </button>
                    </div>
                    <p v-if="passwordCopied" class="text-sm text-success mt-2">
                        <i class="bi bi-check-circle"></i> Skopiowano!
                    </p>
                </div>
            </div>
        </div>

        <div class="divider my-0 opacity-20"></div>

        <!-- === Sekcja 4: Role === -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
            <div>
                <h2 class="text-xl font-semibold mb-1">Przypisz role</h2>
                <p class="text-sm opacity-40">
                    Wybierz role, które użytkownik będzie pełnił w systemie. Możesz wybrać wiele ról.
                </p>
            </div>
            <div class="flex flex-col gap-2">
                @foreach (var role in allRoles)
                {
                    <label class="flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-base-200 transition-colors">
                        <input type="checkbox" 
                               name="SelectedRoles" 
                               value="@role" 
                               class="checkbox checkbox-primary"
                               @(Model.SelectedRoles.Contains(role) ? "checked" : "") />
                        <i class="@role.GetRoleIcon() text-lg"></i>
                        <span class="label-text font-medium flex-1">@role.ToPolishName()</span>
                        <span class="badge badge-xs @GetBadgeColorClass(role)">@role.ToString()</span>
                    </label>
                }
            </div>
        </div>

        <div class="divider my-0 opacity-20"></div>

        <div asp-validation-summary="All" class="text-sm text-error"></div>

        <!-- === Submit === -->
        <div class="flex justify-center">
            <a asp-action="Users" type="button" class="btn btn-neutral btn-soft text-base-content font-normal justify-self-start mr-auto">
                <i class="bi bi-caret-left-fill"></i> Wróć do listy
            </a>
            <button type="submit" class="btn btn-primary">Utwórz użytkownika</button>
            <a asp-action="Users" type="button" class="btn btn-neutral btn-soft text-base-content font-normal justify-self-start ml-auto invisible">
                <i class="bi bi-caret-left-fill"></i> Wróć do listy
            </a>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <partial name="_VueScript" />
    
    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    password: '',
                    confirmPassword: '',
                    generatedPassword: null,
                    passwordCopied: false
                }
            },
            mounted() {
                registerVueApp('create-user-app');
            },
            methods: {
                generatePassword() {
                    const length = 12;
                    const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@@#$%^&*";
                    let password = "";
                    
                    for (let i = 0; i < length; i++) {
                        const randomIndex = Math.floor(Math.random() * charset.length);
                        password += charset[randomIndex];
                    }
                    
                    this.generatedPassword = password;
                    this.password = password;
                    this.confirmPassword = password;
                    this.passwordCopied = false;
                },
                async copyGeneratedPassword() {
                    try {
                        await navigator.clipboard.writeText(this.generatedPassword);
                        this.passwordCopied = true;
                        setTimeout(() => {
                            this.passwordCopied = false;
                        }, 3000);
                    } catch (error) {
                        console.error('Failed to copy:', error);
                    }
                }
            }
        }).mount('#create-user-app');
    </script>
}
