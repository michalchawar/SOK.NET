@using Microsoft.AspNetCore.Razor.Language.Intermediate
@using SOK.Domain.Enums

@functions {
	private class SidebarOption
	{
		public string DisplayName { get; set; } = string.Empty;
		public string Controller { get; set; } = string.Empty;
		public string Action { get; set; } = string.Empty;
		public string Icon { get; set; } = string.Empty;
		public bool Disabled { get; set; } = false;
		public bool Active { get; set; } = false;
		public bool OffsetSection { get; set; } = false;
		public bool RequiresParish { get; set; } = true;
		public Role[]? RequiredRoles { get; set; } = null;

		public bool IsAccessible(System.Security.Claims.ClaimsPrincipal user, bool hasSelectedParish)
		{
			// Jeśli opcja wymaga parafii i użytkownik jest SuperAdmin bez wybranej parafii, ukryj
			if (RequiresParish && user.IsInRole(Role.SuperAdmin.ToString()) && !hasSelectedParish)
				return false;
			
			if (RequiredRoles == null || RequiredRoles.Length == 0)
				return true;

			return RequiredRoles.Any(role => user.IsInRole(role.ToString()))
				|| user.IsInRole(Role.SuperAdmin.ToString());
		}
	}
}

<label for="sidebar-drawer" 
	class="btn btn-ghost hover:bg-base-200 rounded-sm drawer-button 
		tooltip tooltip-right self-end size-12"
	data-tip="Otwórz/Zamknij menu">
	<i class="bi bi-list text-2xl"></i>
</label>

@{
	var activePage = ViewData["ActivePage"] as string;
	
	string selectedParishUid = Context.Request.Cookies.TryGetValue("SelectedParishUid", out var value) ? value : string.Empty;
	bool hasSelectedParish = !string.IsNullOrWhiteSpace(selectedParishUid);

	bool shouldOffset = false;

	var menuItems = new List<SidebarOption>
	{
		new SidebarOption
		{
			DisplayName = "Przegląd",
			Controller = "Home",
			Action = "Index",
			Icon = "house-fill",
			Active = activePage == "Home",
		},
		new SidebarOption
		{
			DisplayName = "Zgłoszenia",
			Controller = "Submissions",
			Action = "Index",
			Icon = "envelope-paper-fill",
			Active = activePage == "Submissions",
			RequiredRoles = new[] { Role.Administrator, Role.Priest, Role.SubmitSupport }
		},
		new SidebarOption
		{
			DisplayName = "Kalendarz",
			Controller = "Calendar",
			Action = "Index",
			Icon = "calendar-week-fill",
			Active = activePage == "Calendar",
			RequiredRoles = new[] { Role.Administrator, Role.Priest }
		},
		new SidebarOption
		{
			DisplayName = "Plany kolędowe",
			Controller = "Plans",
			Action = "Index",
			Icon = "list-nested",
			Active = activePage == "Plans",
			RequiredRoles = new[] { Role.Administrator, Role.Priest }
		},
		new SidebarOption
		{
			DisplayName = "Utwórz zgłoszenie",
			Controller = "Submissions",
			Action = "New",
			Icon = "plus-square-dotted",
			Active = activePage == "NewSubmission",
			RequiredRoles = new[] { Role.Administrator, Role.Priest, Role.SubmitSupport }
		},
		new SidebarOption() 
		{
			DisplayName = "Zarządzanie parafiami",
			Controller = "ParishManagement",
			Action = "Index",
			Icon = "building-fill-gear",
			Active = activePage == "ParishManagement",
			OffsetSection = true,
			RequiresParish = false,
			RequiredRoles = new[] { Role.SuperAdmin }
		},
		new SidebarOption() 
		{
			DisplayName = "Ustawienia",
			Controller = "Settings",
			Action = "Index",
			Icon = "gear",
			Active = activePage == "Settings",
			RequiredRoles = new[] { Role.Administrator }
		},
	};
}

<ul class="menu font-outfit flex-1 gap-1 text-lg font-medium p-0 w-full">
	@foreach (var option in menuItems)
	{
		shouldOffset = shouldOffset || option.OffsetSection;

		@if (option.IsAccessible(User, hasSelectedParish))
		{
			<li class="@(shouldOffset ? "mt-auto" : "")">
				<a asp-controller="@option.Controller" asp-action="@option.Action"
					class="flex items-center gap-3 rounded-md transition-colors whitespace-nowrap 
						hover:bg-primary hover:text-base-content is-drawer-close:tooltip is-drawer-close:tooltip-right
						h-12 w-full is-drawer-close:w-12 px-3.5
						@(option.Active ? "bg-base-100 text-base-content" : "") 
						@(option.Disabled ? "opacity-50 pointer-events-none cursor-not-allowed" : "")"
						data-tip="@option.DisplayName">
					<i class="bi bi-@option.Icon text-2xl lg:text-xl"></i>
					<span class="is-drawer-close:hidden">@option.DisplayName</span>
				</a>
			</li>

			shouldOffset = false;
		}
	}
</ul>