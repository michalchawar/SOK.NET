@using SOK.Domain.Enums
@model NewSubmissionVM

@{
    ViewData["Title"] = "Wprowadź zgłoszenie";
}

<div class="my-auto flex flex-col items-center align-middle">
    <h2 class="mb-5 text-lg font-semibold">Utwórz nowe zgłoszenie:</h2>

    <form asp-action="New" method="post" class="w-full md:w-2/3">
        <div class="grid grid-cols-1 lg:grid-cols-2 justify-center gap-x-4 gap-y-5">
            <div class="">
                <label asp-for="Name" class="floating-label">
                    <span>@Html.DisplayNameFor(m => m.Name)</span>
                    <input asp-for="Name" placeholder="@Html.DisplayNameFor(m => m.Name)"
                        class="input w-full input-lg focus:input-primary" />
                </label>
                <span asp-validation-for="Name" class="text-error"></span>
            </div>

            <div class="">
                <label asp-for="Surname" class="floating-label">
                    <span>@Html.DisplayNameFor(m => m.Surname)</span>
                    <input asp-for="Surname" placeholder="@Html.DisplayNameFor(m => m.Surname)"
                        class="input w-full input-lg focus:input-primary" />
                </label>
                <span asp-validation-for="Surname" class="text-error"></span>
            </div>

            <div class="col-span-full">
                <label asp-for="Email" class="floating-label">
                    <span>@Html.DisplayNameFor(m => m.Email)</span>
                    <input asp-for="Email" placeholder="@Html.DisplayNameFor(m => m.Email)"
                        class="input w-full input-lg focus:input-primary" />
                </label>
                <span asp-validation-for="Email" class="text-error"></span>
            </div>

            <div class="hidden">
                <label asp-for="Phone" class="floating-label">
                    <span>@Html.DisplayNameFor(m => m.Phone)</span>
                    <input asp-for="Phone" placeholder="@Html.DisplayNameFor(m => m.Phone)"
                        class="input w-full input-lg focus:input-primary" />
                </label>
                <span asp-validation-for="Phone" class="text-error"></span>
            </div>

            <div class="divider divider-end col-span-full my-2">
                <label asp-for="SubmissionDate" class="floating-label min-w-44 text-base-content"
                    id="date-picker-container">
                    <span>@Html.DisplayNameFor(m => m.SubmissionDate)</span>
                    <input asp-for="SubmissionDate" type="date" class="input input-sm w-full focus:input-primary"
                        tabindex="-1" id="submission-date-input" />
                </label>
                <label asp-for="ScheduleId" class="floating-label min-w-44 text-base-content">
                    <span>@Html.DisplayNameFor(m => m.ScheduleId)</span>
                    <select asp-for="ScheduleId" asp-items="@Model.ScheduleList" tabindex="-1"
                        class="select select-sm w-full focus:select-primary">
                    </select>
                </label>
            </div>

            <div class="">
                <label asp-for="StreetId" class="floating-label">
                    <span>@Html.DisplayNameFor(m => m.StreetId)</span>
                    <select asp-for="StreetId" asp-items="@Model.StreetList"
                        class="select select-lg w-full focus:select-primary">
                        <option disabled selected class="">--Wybierz--</option>
                    </select>
                </label>
                <span asp-validation-for="StreetId" class="text-error"></span>
            </div>

            <div class="flex gap-x-4">
                <div class="w-1/2">
                    <label asp-for="BuildingId" class="floating-label">
                        <span>@Html.DisplayNameFor(m => m.BuildingId)</span>
                        <select asp-for="BuildingId"
                            asp-items="@(Model.BuildingList.ContainsKey(Model.StreetId) ? Model.BuildingList[Model.StreetId] : new List<SelectListItem>())"
                            class="select select-lg w-full focus:select-primary">
                            <option disabled selected class="">--Wybierz--</option>
                        </select>
                    </label>
                    <span asp-validation-for="BuildingId" class="text-error"></span>
                </div>

                <div class="w-1/2">
                    <label asp-for="Apartment" class="floating-label">
                        <span>@Html.DisplayNameFor(m => m.Apartment)</span>
                        <input asp-for="Apartment" placeholder="@Html.DisplayNameFor(m => m.Apartment)"
                            class="input input-lg w-full focus:input-primary" />
                    </label>
                    <span asp-validation-for="Apartment" class="text-error"></span>
                </div>
            </div>

            <div class="hidden">
                <label asp-for="SubmitterNotes" class="floating-label">
                    <span>@Html.DisplayNameFor(m => m.SubmitterNotes)</span>
                    <textarea asp-for="SubmitterNotes" placeholder="@Html.DisplayNameFor(m => m.SubmitterNotes)"
                        class="textarea w-full textarea-lg focus:textarea-primary">
                            </textarea>
                </label>
                <span asp-validation-for="SubmitterNotes" class="text-error"></span>
            </div>

            <div class="hidden">
                <label asp-for="AdminNotes" class="floating-label">
                    <span>@Html.DisplayNameFor(m => m.AdminNotes)</span>
                    <textarea asp-for="AdminNotes" placeholder="@Html.DisplayNameFor(m => m.AdminNotes)"
                        class="textarea w-full textarea-lg focus:textarea-primary">
                            </textarea>
                </label>
                <span asp-validation-for="AdminNotes" class="text-error"></span>
            </div>

            <div asp-validation-summary="ModelOnly" class="col-span-full text-center text-error"></div>

            <div class="divider col-span-full mt-5">
                <button type="submit" class="btn btn-primary w-1/3">Dodaj</button>
                <label class="btn btn-soft swap w-auto lg:w-1/6">
                    <input type="checkbox" id="form-extender" />
                    <div class="swap-on">-&nbsp;&nbsp;Mniej</div>
                    <div class="swap-off">+&nbsp;&nbsp;Więcej</div>
                </label>
            </div>

            <div class="col-span-full">
                <div class="flex flex-col items-center justify-center gap-2 mb-2">
                    <span class="font-semibold">Metoda zgłoszenia:</span>
                    <div class="join">
                        <input asp-for="Method" type="radio" checked="@(Model.Method == SubmitMethod.PaperForm)"
                            class="join-item btn not-checked:btn-soft checked:btn-accent" id="method-paper-form"
                            value="@((int)SubmitMethod.PaperForm)" aria-label="Formularz papierowy" />
                        <input asp-for="Method" type="radio" checked="@(Model.Method == SubmitMethod.Stationary)"
                            class="join-item btn not-checked:btn-soft checked:btn-accent" id="method-stationary"
                            value="@((int)SubmitMethod.Stationary)" aria-label="Stacjonarnie" />
                        <input asp-for="Method" type="radio" checked="@(Model.Method == SubmitMethod.Phone)"
                            class="join-item btn not-checked:btn-soft checked:btn-accent" id="method-phone"
                            value="@((int)SubmitMethod.Phone)" aria-label="Telefonicznie" />
                        <input asp-for="Method" type="radio" checked="@(Model.Method == SubmitMethod.NotRegistered)"
                            class="join-item btn btn-dash checked:btn-accent" id="method-not-registered"
                            value="@((int)SubmitMethod.NotRegistered)" aria-label="Nie zarejestrowano" />
                    </div>
                </div>
            </div>

            <div class="col-span-full text-center flex flex-col gap-3">
                <label asp-for="SendNotificationEmail" class="cursor-pointer select-none tooltip"
                    data-tip="Jeśli podano adres e-mail, zostanie wysłane potwierdzenie otrzymania zgłoszenia.">
                    <input asp-for="SendNotificationEmail" type="checkbox" class="checkbox checkbox-primary mr-2" />
                    <span>@Html.DisplayNameFor(m => m.SendNotificationEmail)</span>
                </label>
                <label for="use-custom-date" class="cursor-pointer select-none tooltip"
                    data-tip="Domyślnie zgłoszenie zostanie dodane z teraźniejszą datą i godziną. Zaznacz tę opcję, aby wybrać inną datę. System dodatkowo ustawi godzinę na 7:00 wybranego dnia.">
                    <input asp-for="UseCustomDate" type="checkbox" id="use-custom-date"
                        class="checkbox mr-2" />
                    <span>@Html.DisplayNameFor(m => m.UseCustomDate)</span>
                </label>
            </div>

            <div class="col-span-full alert alert-info alert-soft mt-4 flex items-center gap-2">
                <i class="bi bi-info-circle"></i>
                <span>
                    Aby przejść do następnego podstawowego pola formularza, naciśnij spację.
                    Aby wprowadzić znak spacji w polu tekstowym, użyj <kbd class="kbd">Shift</kbd> + <kbd class="kbd">Spacja</kbd>.
                </span>
            </div>

        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const streetSelect = document.getElementById("StreetId");
            const buildingSelect = document.getElementById("BuildingId");

            const buildingOptions = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.BuildingList));

            registerBuildingPicker(streetSelect, buildingSelect, buildingOptions);
        });

        // Auto-focus na pierwszym inpucie i nawigacja spacją
        document.addEventListener("DOMContentLoaded", function () {
            const nameInput = document.getElementById("Name");
            const surnameInput = document.getElementById("Surname");
            const streetSelect = document.getElementById("StreetId");
            const buildingSelect = document.getElementById("BuildingId");
            const apartmentInput = document.getElementById("Apartment");

            const navigationFields = [nameInput, surnameInput, streetSelect, buildingSelect, apartmentInput];

            // Auto-focus na pierwszym polu
            nameInput.focus();

            // Nawigacja spacją między polami
            navigationFields.forEach((field, index) => {
                field.addEventListener("keydown", function (e) {
                    if (e.key === " " && !e.shiftKey && e.target.tagName === "INPUT" && e.target.type === "text") {
                        // Dla inputów tekstowych blokujemy spację i przechodzimy dalej
                        e.preventDefault();
                        const nextIndex = (index + 1) % navigationFields.length;
                        navigationFields[nextIndex].focus();
                    } else if (e.key === " " && !e.shiftKey && e.target.tagName === "SELECT") {
                        // Dla selectów również przechodzimy dalej na spację
                        e.preventDefault();
                        const nextIndex = (index + 1) % navigationFields.length;
                        navigationFields[nextIndex].focus();
                    }
                });
            });

            // Obsługa Enter na selekcie bramy do wysłania formularza
            buildingSelect.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                    e.preventDefault();
                    const form = this.closest("form");
                    if (form) {
                        form.submit();
                    }
                }
            });
        });

        document.addEventListener("DOMContentLoaded", function () {
            const formExtender = document.getElementById("form-extender");

            const emailInput = document.getElementById("Email").parentElement.parentElement;
            const phoneInput = document.getElementById("Phone").parentElement.parentElement;
            const submitterNotes = document.getElementById("SubmitterNotes").parentElement.parentElement;
            const adminNotes = document.getElementById("AdminNotes").parentElement.parentElement;

            formExtender.addEventListener("change", function () {
                const extended = this.checked;

                if (extended) {
                    emailInput.classList.remove("col-span-full");
                    phoneInput.classList.remove("hidden");
                    submitterNotes.classList.remove("hidden");
                    adminNotes.classList.remove("hidden");
                } else {
                    emailInput.classList.add("col-span-full");
                    phoneInput.classList.add("hidden");
                    submitterNotes.classList.add("hidden");
                    adminNotes.classList.add("hidden");
                }
            });
        });

        document.addEventListener("DOMContentLoaded", function () {
            const useCustomDateCheckbox = document.getElementById("use-custom-date");
            const datePickerContainer = document.getElementById("date-picker-container");
            const dateInput = document.getElementById("submission-date-input");

            function updateDateFieldVisibility() {
                if (useCustomDateCheckbox.checked) {
                    datePickerContainer.style.display = "";
                    dateInput.removeAttribute("disabled");
                } else {
                    datePickerContainer.style.display = "none";
                    dateInput.setAttribute("disabled", "disabled");
                }
            }

            // Initialize on page load
            updateDateFieldVisibility();

            useCustomDateCheckbox.addEventListener("change", updateDateFieldVisibility);
        });
    </script>
}