@{
    ViewData["Title"] = "Zgłoszenia";
}

<div id="submissions-app" class="h-full">
    <div class="flex h-full">
        <!-- filtr -->
        <div class="flex min-w-1/3 flex-shrink-0 flex-col gap-y-8 overflow-y-scroll p-2 text-center">
            <h2 class="text-semibold text-3xl">Wyszukaj:</h2>

            <fieldset class="fieldset">
                <legend class="fieldset-legend text-lg font-normal opacity-50">
                    Szukaj po adresie:
                </legend>
                <label class="input input-lg w-full">
                    <i class="bi bi-geo-alt-fill"></i>

                    <input v-model="filters.address" v-on:input="loadSubmissions"
                        placeholder="np. @(ViewData["SampleAddress"] ?? "Brzozowa 45/3")" class="" type="text" />
                </label>
            </fieldset>

            <fieldset class="fieldset">
                <legend class="fieldset-legend text-lg font-normal opacity-50">
                    Szukaj po imieniu i nazwisku:
                </legend>
                <label class="input input-lg w-full">
                    <i class="bi bi-person-fill"></i>

                    <input v-model="filters.person" v-on:input="loadSubmissions"
                        placeholder="np. @(ViewData["SampleSurname"] ?? "Kowalski")..." class="" type="text" />
                </label>
            </fieldset>
        </div>

        <div class="divider divider-horizontal h-full">
            <i class="bi bi-chevron-double-right text-(--divider-color)"></i>
        </div>

        <!-- lista -->
        <div class="flex-grow overflow-y-scroll py-2 ps-2 pe-4" v-if="submissions.length > 0 || !isDataLoaded">
            <div class="flex flex-col gap-2">
                <div v-for="s in submissions" :key="s.id"
                    @@click="openModal(s.id)"
                    class="submission-card bg-base-200 grid cursor-pointer grid-cols-[3fr_1fr] grid-rows-[20%_40%_40%] px-4 py-3 transition-colors hover:bg-base-300">
                    <div class="mb-0 opacity-40">
                        <span>{{ s.address.streetType }}</span>
                    </div>
                    <div class="mb-3 text-2xl">
                        <b>{{ s.address.streetName }}</b> {{ s.address.buildingNumber }}{{ s.address.buildingLetter }}
                        <span class="ms-3 text-lg opacity-60">m.</span> {{ s.address.apartmentNumber }}{{
                        s.address.apartmentLetter }}
                    </div>
                    <div class="text-md opacity-80">
                        <b>{{ s.submitter.surname }}</b> {{ s.submitter.name }}
                    </div>
                    <div class="col-start-2 row-span-full flex justify-end px-5">
                        <div class="flex flex-col justify-center text-center text-sm opacity-50">
                            <i class="bi bi-arrow-counterclockwise text-2xl"></i>
                            {{ s.timeAgo }}
                        </div>
                    </div>
                </div>

                <!-- lista dummy do ładowania -->
                <div v-if="!isDataLoaded" v-for="n in 10" :key="n"
                    class="bg-base-200 grid cursor-default grid-cols-[3fr_1fr] grid-rows-[20%_40%_40%] gap-y-2 px-4 py-3">
                    <div class="skeleton mb-0 h-4 w-20 rounded-sm opacity-60"></div>
                    <div class="skeleton mb-3 h-7 w-40 rounded-sm text-2xl"></div>
                    <div class="text-md skeleton h-4 w-32 rounded-sm opacity-80"></div>
                    <div class="col-start-2 row-span-full flex items-center justify-end">
                        <div class="text-md skeleton flex size-12 flex-col justify-center rounded-sm text-center"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex h-full flex-grow flex-col items-center justify-center p-5 opacity-70" v-else>
            <i class="bi bi-dash-lg text-4xl -mt-5 mb-10"></i>
            <h2 class="text-center text-xl font-semibold">
                Nie znaleziono zgłoszeń.
            </h2>
            <h4 class="text-center text-lg opacity-70">
                W systemie nie ma zgłoszeń spełniających podane kryteria wyszukiwania.
            </h4>
        </div>
    </div>
</div>

<partial name="_SubmissionModal" />

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <partial name="_VueScript" />
    
    <script src="~/js/address-utilities.js"></script>
    
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    submissions: [],
                    filters: {
                        address: "",
                        person: "",
                    },
                    isDataLoaded: false,
                    timeoutIds: new Map(),
                    debounceTimeout: null,
                }
            },
            mounted() {
                this.loadSubmissions();
                registerVueApp('submissions-app');
                
                // Inicjalizuj modal
                window.initSubmissionModal();
                
                // Callback po aktualizacji
                window.onSubmissionUpdated = () => {
                    this.loadSubmissions();
                };
            },
            beforeUnmount() {
                // Wyczyść wszystkie timery przy unmount
                this.timeoutIds.forEach(timeoutId => clearTimeout(timeoutId));
                this.timeoutIds.clear();
                if (this.debounceTimeout) {
                    clearTimeout(this.debounceTimeout);
                }
            },
            methods: {
                openModal(id) {
                    window.openSubmissionModal(id);
                },
                loadSubmissions() {
                    // Debouncing - czekaj 250ms po ostatnim wpisaniu
                    if (this.debounceTimeout) {
                        clearTimeout(this.debounceTimeout);
                    }
                    
                    this.debounceTimeout = setTimeout(() => {
                        this.fetchSubmissions();
                    }, 250);
                },
                async fetchSubmissions() {
                    this.isDataLoaded = false;

                    // Wyczyść poprzednie timery
                    this.timeoutIds.forEach(timeoutId => clearTimeout(timeoutId));
                    this.timeoutIds.clear();

                    let response = await fetch(`/api/submissions?address=${encodeURIComponent(this.filters.address)}&submitter=${encodeURIComponent(this.filters.person)}`);
                    this.submissions = await response.json();

                    console.log(this.submissions);

                    this.submissions.forEach(s => {
                        s.timeAgo = computeTimeDiffString(s.submitTime + "Z");
                        this.scheduleNextUpdate(s);
                    });

                    this.isDataLoaded = true;
                },
                scheduleNextUpdate(submission) {
                    let diff = Date.now() - new Date(submission.submitTime + "Z");
                    let interval = {
                        seconds: Math.floor(diff / 1000),
                        minutes: Math.floor(diff / (1000 * 60)),
                        hours: Math.floor(diff / (1000 * 60 * 60)),
                        days: Math.floor(diff / (1000 * 60 * 60 * 24)),
                    };

                    let nextUpdateMs;

                    if (interval.seconds < 60) {
                        // Aktualizuj co sekundę
                        nextUpdateMs = 1000;
                    } else if (interval.minutes < 60) {
                        // Aktualizuj co minutę (przy pełnej minucie)
                        nextUpdateMs = (60 - interval.seconds % 60) * 1000;
                    } else if (interval.hours < 24) {
                        // Aktualizuj co godzinę (przy pełnej godzinie)
                        nextUpdateMs = (60 - interval.minutes % 60) * 60 * 1000;
                    } else {
                        // Aktualizuj co dzień (przy pełnym dniu)
                        nextUpdateMs = (24 - interval.hours % 24) * 60 * 60 * 1000;
                    }

                    // Wyczyść poprzedni timeout jeśli istnieje
                    if (this.timeoutIds.has(submission.id)) {
                        clearTimeout(this.timeoutIds.get(submission.id));
                    }

                    // Zaplanuj następną aktualizację
                    let timeoutId = setTimeout(() => {
                        submission.timeAgo = computeTimeDiffString(submission.submitTime + "Z");
                        this.scheduleNextUpdate(submission);
                    }, nextUpdateMs);

                    this.timeoutIds.set(submission.id, timeoutId);
                },
            }
        }).mount("#submissions-app");

        function computeNounEnding(number, declination) {
            if (number == 1) return declination[0];
            if (number > 10 && number < 20) return declination[2];
            if ((number % 10) >= 2 && (number % 10) <= 4) return declination[1];
            return declination[2];
        };
        function computeTimeDiffString(date) {
            let diff = Date.now() - new Date(date);
            let interval = {
                seconds: Math.floor(diff / 1000),
                minutes: Math.floor(diff / (1000 * 60)),
                hours: Math.floor(diff / (1000 * 60 * 60)),
                days: Math.floor(diff / (1000 * 60 * 60 * 24)),
                weeks: Math.floor(diff / (1000 * 60 * 60 * 24 * 7)),
                months: Math.floor(diff / (1000 * 60 * 60 * 24 * 30)),
                years: Math.floor(diff / (1000 * 60 * 60 * 24 * 365))
            }

            if (interval.years)
                return `${interval.years} ${computeNounEnding(interval.years, ["rok", "lata", "lat"])} temu`;
            if (interval.months)
                return `${interval.months} ${computeNounEnding(interval.months, ["miesiąc", "miesiące", "miesięcy"])} temu`;
            if (interval.days)
                return `${interval.days} ${computeNounEnding(interval.days, ["dzień", "dni", "dni"])} temu`;
            if (interval.hours)
                return `${interval.hours} ${computeNounEnding(interval.hours, ["godzinę", "godziny", "godzin"])} temu`;
            if (interval.minutes)
                return `${interval.minutes} ${computeNounEnding(interval.minutes, ["minutę", "minuty", "minut"])} temu`;

            return `${interval.seconds} ${computeNounEnding(interval.seconds, ["sekundę", "sekundy", "sekund"])} temu`;
        };
    </script>

}