@model int

<!-- Modal przypisywania budynków -->
<dialog id="assign-buildings-modal" class="modal">
    <div id="assign-buildings-app" class="modal-box w-full max-w-7xl h-[90vh] flex flex-col p-0">
        <!-- Header -->
        <div class="sticky top-0 z-10 bg-base-100 border-b border-base-300 px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-xl font-bold">Zarządzaj przypisaniami budynków</h3>
                    <p class="text-sm text-base-content/70 mt-1">
                        Dzień kolędowy: <span class="font-semibold" id="modalDayDate"></span>
                    </p>
                </div>
                <button type="button" class="btn btn-sm btn-circle btn-ghost" @@click="closeMainModal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>

        <!-- Vue App -->
        <div class="flex-1 overflow-hidden flex flex-col">
            <!-- Loading State -->
            <div v-if="loading" class="flex-1 flex items-center justify-center">
                <span class="loading loading-spinner loading-lg"></span>
            </div>

            <!-- Content -->
            <template v-else>
                <!-- Filters and Actions Bar -->
                <div class="px-6 pt-4 pb-2 bg-base-100 border-b border-base-300">
                    <div class="flex flex-wrap gap-4 items-end justify-between">
                        <!-- Left side: Filters -->
                        <div class="flex flex-wrap gap-4 items-end">
                            <!-- Schedule filter -->
                            <div class="flex flex-col gap-1">
                                <label class="label py-0">
                                    <span class="label-text font-semibold">Harmonogram</span>
                                </label>
                                <div class="flex gap-2">
                                    <div v-for="schedule in schedules"
                                        :key="schedule.id"
                                        class="join cursor-pointer"
                                        @@click="filterScheduleId = schedule.id"
                                        :style="{ '--schedule-color': schedule.color }">
                                        <button
                                            type="button"
                                            class="join-item h-8 rounded-l-md flex-1 btn btn-sm justify-start"
                                            :class="filterScheduleId === schedule.id ? 'btn-primary' : ''">
                                            {{ schedule.name }}
                                        </button>
                                        <div class="size-8 rounded-r-md bg-(--schedule-color)">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Street filter -->
                            <div class="flex flex-col gap-1">
                                <label class="label py-0">
                                    <span class="label-text">Ulica</span>
                                </label>
                                <select v-model="filterStreetId" class="select select-sm w-48">
                                    <option :value="null">Wszystkie</option>
                                    <option v-for="street in streets" :key="street.id" :value="street.id">
                                        {{ street.name }}
                                    </option>
                                </select>
                            </div>
                        </div>

                        <!-- Right side: Bulk Actions -->
                        <div class="flex gap-2">
                            <button 
                                type="button" 
                                class="btn btn-sm btn-ghost"
                                @@click="bulkEnableAutoAssign"
                                :disabled="filteredAssignments.length === 0">
                                <i class="bi bi-check-lg"></i>
                                Włącz auto-zapis
                            </button>
                            <button 
                                type="button" 
                                class="btn btn-sm btn-ghost"
                                @@click="bulkDisableAutoAssign"
                                :disabled="filteredAssignments.length === 0">
                                <i class="bi bi-x-lg"></i>
                                Wyłącz auto-zapis
                            </button>
                            <button 
                                type="button" 
                                class="btn btn-sm btn-error btn-soft"
                                @@click="bulkRemoveAssignments"
                                :disabled="filteredAssignments.length === 0">
                                <i class="bi bi-trash"></i>
                                Usuń wszystkie
                            </button>
                            <button 
                                type="button" 
                                class="btn btn-sm btn-primary"
                                @@click="openAddBuildingsModal">
                                <i class="bi bi-plus-lg"></i>
                                Dodaj bramy
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Assignments List -->
                <div class="flex-1 overflow-auto px-6 py-4">
                    <div v-if="filteredAssignments.length === 0" class="text-center py-12 text-base-content/60">
                        <p class="text-lg mb-2">Brak przypisań</p>
                        <p class="text-sm">Kliknij "Dodaj bramy", aby dodać przypisania budynków</p>
                    </div>
                    <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                        <div
                            v-for="assignment in filteredAssignments"
                            :key="`${assignment.buildingId}-${assignment.scheduleId}`"
                            class="card card-compact bg-base-200 border-2"
                            :class="assignment.isNew ? 'border-warning' : 'border-transparent'">
                            <div class="card-body">
                                <div class="flex items-start justify-between gap-2">
                                    <div class="flex-1 min-w-0">
                                        <div class="font-semibold truncate">{{ assignment.streetName }}</div>
                                        <div class="text-2xl font-bold">{{ assignment.buildingNumber }}</div>
                                    </div>
                                    <div class="flex flex-col gap-1 items-end">
                                        <div v-if="assignment.isNew" class="badge badge-warning badge-sm">
                                            Nowe
                                        </div>
                                        <button 
                                            type="button"
                                            class="btn btn-sm btn-circle btn-ghost text-error"
                                            @@click="removeAssignment(assignment.buildingId, assignment.scheduleId)">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="text-sm text-base-content/70 mt-2">
                                    <div>Zgłoszenia: <strong>{{ assignment.submissionsTotal }}</strong></div>
                                    <div v-if="assignment.submissionsAssigned > 0" class="text-success">
                                        Przypisane: <strong>{{ assignment.submissionsAssigned }}</strong>
                                    </div>
                                </div>
                                <div class="mt-3 flex items-center gap-2">
                                    <input 
                                        type="checkbox" 
                                        :id="`auto-assign-${assignment.buildingId}-${assignment.scheduleId}`"
                                        v-model="assignment.enableAutoAssign" 
                                        class="checkbox checkbox-sm checkbox-primary" />
                                    <label 
                                        :for="`auto-assign-${assignment.buildingId}-${assignment.scheduleId}`"
                                        class="text-xs cursor-pointer">
                                        Automatyczne przypisywanie
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Footer -->
        <div class="sticky bottom-0 z-10 bg-base-100 border-t border-base-300 px-6 py-4 flex justify-end gap-3">
            <button type="button" class="btn btn-ghost" @@click="closeMainModal">Anuluj</button>
            <button 
                type="button" 
                class="btn btn-primary"
                @@click="saveAssignments"
                :disabled="saving || !hasChanges">
                <span v-if="saving" class="loading loading-spinner"></span>
                <span v-else>Zapisz</span>
            </button>
        </div>

        <!-- Modal wyboru agendy --> 
        <dialog id="agenda-assignment-modal" class="modal">
            <div class="modal-box max-w-2xl">
                <h3 class="text-lg font-bold mb-4">Przypisz zgłoszenia do agendy</h3>
                
                <div v-if="agendaAssignmentLoading" class="flex justify-center py-8">
                    <span class="loading loading-spinner loading-lg"></span>
                </div>
                
                <template v-else>
                    <p class="text-sm text-base-content/70 mb-4">
                        Nieprzypisane zgłoszenia z wybranych budynków mogą zostać automatycznie przypisane do agendy.
                        Wybierz agendę lub pomiń ten krok:
                    </p>
                    
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Istniejące agendy -->
                        <div 
                            v-for="agenda in availableAgendas" 
                            :key="agenda.id"
                            class="card bg-base-200 cursor-pointer hover:bg-base-300 transition-colors"
                            :class="{ 'bg-base-300': selectedAgendaId === agenda.id }"
                            @@click="selectedAgendaId = agenda.id">
                            <div class="card-body p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <div class="font-semibold">{{ agenda.priestName || 'Brak księdza' }}</div>
                                        <div v-if="agenda.ministerNames.length > 0" class="text-sm text-base-content/70">
                                            Ministranci: {{ agenda.ministerNames.join(', ') }}
                                        </div>
                                        <div class="text-sm text-base-content/70">
                                            Wizyt: {{ agenda.visitsCount }} | {{ agenda.startHour }} - {{ agenda.endHour }}
                                        </div>
                                    </div>
                                    <input 
                                        type="radio" 
                                        :checked="selectedAgendaId === agenda.id" 
                                        class="radio radio-primary" 
                                        @@click.stop="selectedAgendaId = agenda.id" />
                                </div>
                            </div>
                        </div>
                        
                        <!-- Opcja utworzenia nowej agendy -->
                        <div 
                            class="card bg-base-200 cursor-pointer hover:bg-base-300 transition-colors border-2 border-dashed"
                            :class="{ 'bg-base-300': selectedAgendaId === -1 }"
                            @@click="selectedAgendaId = -1">
                            <div class="card-body p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <div class="font-semibold flex items-center gap-2">
                                            <i class="bi bi-plus-lg"></i>
                                            Utwórz nową agendę
                                        </div>
                                        <div class="text-sm text-base-content/70">
                                            Zostanie utworzona nowa agenda bez przypisanych księży
                                        </div>
                                    </div>
                                    <input 
                                        type="radio" 
                                        :checked="selectedAgendaId === -1" 
                                        class="radio radio-primary" 
                                        @@click.stop="selectedAgendaId = -1" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="divider my-2"></div>

                    <p class="text-sm text-base-content/70 mb-3">
                        Dodatkowe opcje:
                    </p>

                    <div class="flex flex-col gap-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" v-model="sendEmailsToAssigned" class="checkbox checkbox-sm checkbox-primary" />
                            <span class="text-sm">Wyślij powiadomienia mailowe o ustaleniu terminu wizyty</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" v-model="deassignUnassigned" class="checkbox checkbox-sm checkbox-primary" />
                            <span class="text-sm">Wypisz zgłoszenia z usuniętych bram</span>
                        </label>
                    </div>
                </template>
                
                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" @@click="skipAssignmentAndSave">Pomiń przypisywanie</button>
                    <button 
                        type="button" 
                        class="btn btn-primary" 
                        @@click="confirmAgendaAssignment"
                        :disabled="selectedAgendaId === null || assignmentSaving">
                        <span v-if="assignmentSaving" class="loading loading-spinner"></span>
                        <span v-else>Przypisz zgłoszenia</span>
                    </button>
                </div>
            </div>
            <div class="modal-backdrop" @@click="closeAgendaModal"></div>
        </dialog>
    </div>
</dialog>

<!-- Modal dodawania bram -->
<dialog id="add-buildings-modal" class="modal">
    <div id="add-buildings-app" class="modal-box w-full max-w-6xl h-[90vh] flex flex-col p-0">
        <!-- Header -->
        <div class="sticky top-0 z-10 bg-base-100 border-b border-base-300 px-6 py-4">
            <h3 class="text-lg font-bold">Dodaj bramy do przypisań</h3>
        </div>

        <!-- Content -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Left side: Filters and Stats -->
            <div class="w-64 border-r border-base-300 flex flex-col relative">
                <!-- Scrollable filters -->
                <div class="overflow-y-auto px-4 py-4 flex flex-col gap-4 h-full" :style="{ paddingBottom: statsHeight + 'px' }">
                    <!-- Schedule filter -->
                    <div class="flex flex-col gap-1">
                        <label class="label py-0">
                            <span class="label-text font-semibold">Harmonogram</span>
                        </label>
                        <div class="flex flex-col gap-2">
                            <div v-for="schedule in schedules"
                                :key="schedule.id"
                                class="join cursor-pointer"
                                @@click="addFilterScheduleId = schedule.id"
                                :style="{ '--schedule-color': schedule.color }">
                                <button
                                    type="button"
                                    class="join-item h-8 rounded-l-md flex-1 btn btn-sm justify-start"
                                    :class="addFilterScheduleId === schedule.id ? 'btn-primary' : ''">
                                    {{ schedule.name }}
                                </button>
                                <div class="size-8 rounded-r-md bg-(--schedule-color)">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="divider my-0 h-0.5"></div>

                    <!-- Street filter -->
                    <div class="flex flex-col gap-1">
                        <label class="label py-0">
                            <span class="label-text">Ulica</span>
                        </label>
                        <select v-model="addFilterStreetId" class="select select-sm">
                            <option :value="null">Wszystkie</option>
                            <option v-for="street in streets" :key="street.id" :value="street.id">
                                {{ street.name }}
                            </option>
                        </select>
                    </div>

                    <!-- Status filter -->
                    <div class="flex flex-col gap-1">
                        <label class="label py-0">
                            <span class="label-text">Status</span>
                        </label>
                        <div class="flex flex-col gap-1">
                            <button 
                                type="button" 
                                @@click="addFilterStatus = 'all'"
                                class="btn btn-sm justify-start" 
                                :class="[addFilterStatus === 'all' ? 'btn-primary' : 'btn-ghost']">
                                Wszystkie
                            </button>
                            <button 
                                type="button" 
                                @@click="addFilterStatus = 'unassigned'"
                                class="btn btn-sm justify-start" 
                                :class="[addFilterStatus === 'unassigned' ? 'btn-warning' : 'btn-ghost']">
                                Nieprzypisane
                            </button>
                        </div>
                    </div>

                    <!-- Parity filter -->
                    <div class="flex flex-col gap-1">
                        <label class="label py-0">
                            <span class="label-text">Parzystość</span>
                        </label>
                        <div class="join w-full">
                            <button 
                                type="button" 
                                @@click="toggleParity('even')"
                                class="join-item btn btn-sm flex-1" 
                                :class="[addFilterParity === 'even' ? 'btn-accent' : 'btn-ghost']">
                                Parzyste
                            </button>
                            <button 
                                type="button" 
                                @@click="toggleParity('odd')"
                                class="join-item btn btn-sm flex-1" 
                                :class="[addFilterParity === 'odd' ? 'btn-accent' : 'btn-ghost']">
                                Nieparzyste
                            </button>
                        </div>
                    </div>

                    <!-- Sort -->
                    <div class="flex flex-col gap-1">
                        <label class="label py-0">
                            <span class="label-text">Sortuj</span>
                        </label>
                        <div class="flex flex-col gap-1">
                            <button 
                                type="button" 
                                @@click="addSort = 'street'"
                                class="btn btn-sm justify-start" 
                                :class="[addSort === 'street' ? 'btn-accent' : 'btn-ghost']">
                                Ulica
                            </button>
                            <button 
                                type="button" 
                                @@click="addSort = 'building'"
                                class="btn btn-sm justify-start" 
                                :class="[addSort === 'building' ? 'btn-accent' : 'btn-ghost']">
                                Numer budynku
                            </button>
                            <button 
                                type="button" 
                                @@click="addSort = 'submissions'"
                                class="btn btn-sm justify-start" 
                                :class="[addSort === 'submissions' ? 'btn-accent' : 'btn-ghost']">
                                Zgłoszenia
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Fixed stats at bottom -->
                <div ref="statsContainer" class="absolute bottom-0 left-0 right-0 bg-base-100 border-t border-base-300 px-4 py-3 flex flex-col gap-2 z-40">
                    <!-- Zaznaczone widoczne -->
                    <div v-if="hasFiltersApplied" class="bg-warning/10 rounded-lg p-3 text-sm relative">
                        <div class="absolute top-2 right-2 tooltip tooltip-right" data-tip="Liczba zgłoszeń z widocznych i zaznaczonych bram (bez już przypisanych)">
                            <i class="bi bi-question-circle text-xs opacity-50 hover:opacity-100 cursor-help"></i>
                        </div>
                        <div class="font-semibold mb-1">Zaznaczone widoczne:</div>
                        <div class="">Zgłoszenia: <strong>{{ selectedVisibleSubmissionsCount }}</strong></div>
                    </div>

                    <!-- Wyświetlane -->
                    <div class="bg-info/10 rounded-lg p-3 text-sm relative">
                        <div class="absolute top-2 right-2 tooltip tooltip-right" data-tip="Liczba nieprzypisanych zgłoszeń z widocznych bram (bez już przypisanych na dziś)">
                            <i class="bi bi-question-circle text-xs opacity-50 hover:opacity-100 cursor-help"></i>
                        </div>
                        <div class="font-semibold mb-1">Wyświetlane:</div>
                        <div class="">Zgłoszenia: <strong>{{ displayedSubmissionsCount }}</strong></div>
                    </div>

                    <!-- Wszystkie -->
                    <div class="bg-primary/10 rounded-lg p-3 text-sm relative">
                        <div class="absolute top-2 right-2 tooltip tooltip-right" data-tip="Suma wszystkich zgłoszeń: już przypisane dziś + nowo zaznaczone">
                            <i class="bi bi-question-circle text-xs opacity-50 hover:opacity-100 cursor-help"></i>
                        </div>
                        <div class="font-semibold mb-1">Wszystkie:</div>
                        <div class="">Zgłoszenia: <strong>{{ allSubmissionsCount }}</strong></div>
                    </div>
                </div>
            </div>

            <!-- Right side: Buildings list -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <!-- Bulk actions bar -->
                <div class="px-4 py-3 border-b border-base-300 flex justify-between items-center">
                    <div class="text-sm text-base-content/70">
                        Zaznaczono: <strong>{{ selectedNewBuildingsCount }}</strong> 
                        {{ declinateWord(selectedNewBuildingsCount, 'budynek', 'budynki', 'budynków') }}
                        | Zgłoszenia: <strong>{{ selectedNewSubmissionsCount }}</strong>
                    </div>
                    <div class="flex gap-2">
                        <button
                            type="button"
                            class="btn btn-sm btn-ghost"
                            @@click="selectAllFiltered"
                            :disabled="filteredBuildingsForAdd.length === 0">
                            Zaznacz widoczne
                        </button>
                        <button
                            type="button"
                            class="btn btn-sm btn-ghost"
                            @@click="deselectAllFiltered"
                            :disabled="filteredBuildingsForAdd.length === 0">
                            Odznacz widoczne
                        </button>
                        <button
                            type="button"
                            class="btn btn-sm btn-ghost"
                            @@click="deselectAll"
                            :disabled="selectedBuildingsForAdd.length === 0">
                            Odznacz wszystkie
                        </button>
                    </div>
                </div>

                <!-- Buildings grid -->
                <div class="flex-1 overflow-y-auto px-4 py-4">
                    <div v-if="!addFilterScheduleId" class="text-center py-12 text-base-content/60">
                        Wybierz harmonogram, aby wyświetlić budynki
                    </div>
                    <div v-else-if="addBuildingsLoading" class="text-center py-12">
                        <span class="loading loading-spinner loading-lg"></span>
                    </div>
                    <div v-else-if="filteredBuildingsForAdd.length === 0" class="text-center py-12 text-base-content/60">
                        Brak budynków spełniających kryteria
                    </div>
                    <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <button
                            v-for="building in filteredBuildingsForAdd"
                            :key="`${building.buildingId}-${building.scheduleId}`"
                            type="button"
                            class="card card-compact bg-base-200 transition-colors text-left border-2"
                            :class="[
                                isAlreadyAssigned(building) 
                                    ? 'opacity-60 cursor-not-allowed border-success/50 bg-success/5' 
                                    : 'hover:bg-base-300 cursor-pointer border-transparent',
                                (selectedBuildingsForAdd.includes(`${building.buildingId}-${building.scheduleId}`) || isAlreadyAssigned(building))
                                    ? 'ring-2 ring-primary bg-primary/20 border-primary' 
                                    : ''
                            ]"
                            @@click="toggleBuildingSelection(building)"
                            :disabled="isAlreadyAssigned(building)">
                            <div class="card-body">
                                <div class="flex items-start justify-between gap-2">
                                    <div class="flex-1 min-w-0">
                                        <div class="font-semibold truncate">{{ building.streetName }}</div>
                                        <div class="text-2xl font-bold">{{ building.buildingNumber }}</div>
                                    </div>
                                    <div class="flex flex-col gap-1 items-end">
                                        <div v-if="isAlreadyAssigned(building)" class="badge badge-success badge-sm">
                                            Przypisany dziś
                                        </div>
                                        <div v-else-if="building.isAssignedToThisDay" class="badge badge-success badge-sm">
                                            Przypisany
                                        </div>
                                    </div>
                                </div>
                                <div class="text-sm text-base-content/70 mt-2">
                                    <div>Zgłoszenia: <strong>{{ building.submissionsTotal }}</strong></div>
                                    <div v-if="building.submissionsUnassigned > 0" class="text-warning">
                                        Nieprzypisane: <strong>{{ building.submissionsUnassigned }}</strong>
                                    </div>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="sticky bottom-0 z-10 bg-base-100 border-t border-base-300 px-6 py-4 flex justify-end gap-3">
            <button type="button" class="btn btn-ghost" @@click="closeAddBuildingsModal">Anuluj</button>
            <button 
                type="button" 
                class="btn btn-primary"
                @@click="confirmAddBuildings"
                :disabled="selectedBuildingsForAdd.length === 0">
                Dodaj zaznaczone ({{ selectedBuildingsForAdd.length }})
            </button>
        </div>
    </div>
</dialog>

<script>
    let mountedApp = null;
    let addBuildingsApp = null;
    let mainModal = null;
    let addModal = null;
    let agendaModal = null;

    window.initAssignmentModal = function() {
        if (mountedApp) return;

        const { createApp } = Vue;
        const dayId = @Model;

        // Main modal app
        const app = createApp({
            data() {
                return {
                    dayId: dayId,
                    loading: false,
                    saving: false,
                    schedules: [],
                    streets: [],
                    
                    // Assignments (working tree)
                    assignments: [],
                    originalAssignments: [],
                    
                    // Filters
                    filterScheduleId: null,
                    filterStreetId: null,
                    
                    // Agenda assignment modal
                    agendaAssignmentLoading: false,
                    availableAgendas: [],
                    selectedAgendaId: null,
                    sendEmailsToAssigned: false,
                    deassignUnassigned: false,
                    assignmentSaving: false
                };
            },
            mounted() {
                registerVueApp("assign-buildings-app");
                mainModal = document.getElementById('assign-buildings-modal');
            },
            computed: {
                filteredAssignments() {
                    let filtered = this.assignments;
                    
                    if (this.filterScheduleId) {
                        filtered = filtered.filter(a => a.scheduleId === this.filterScheduleId);
                    }
                    
                    if (this.filterStreetId) {
                        filtered = filtered.filter(a => a.streetId === this.filterStreetId);
                    }
                    
                    return filtered;
                },
                hasChanges() {
                    return JSON.stringify(this.assignments) !== JSON.stringify(this.originalAssignments);
                }
            },
            methods: {
                async loadModalData() {
                    this.loading = true;
                    try {
                        const response = await fetch(`/api/Calendar/modal-data?dayId=${this.dayId}`);
                        if (!response.ok) throw new Error('Failed to load modal data');
                        const data = await response.json();
                        
                        this.schedules = data.schedules;
                        this.streets = data.streets;
                        document.getElementById('modalDayDate').textContent = data.date;
                        
                        // Load current assignments
                        await this.loadAssignments();
                        
                        // Set default filter to first schedule
                        if (this.schedules.length > 0) {
                            this.filterScheduleId = this.schedules[0].id;
                        }
                    } catch (error) {
                        console.error('Error loading modal data:', error);
                        alert('Nie udało się załadować danych modalu');
                        this.closeMainModal();
                    } finally {
                        this.loading = false;
                    }
                },
                async loadAssignments() {
                    try {
                        const response = await fetch(`/api/Calendar/day-buildings?dayId=${this.dayId}`);
                        if (!response.ok) throw new Error('Failed to load assignments');
                        const data = await response.json();
                        
                        // Filter only assigned buildings
                        this.assignments = data
                            .filter(b => b.isAssignedToThisDay)
                            .map(a => ({
                                buildingId: a.buildingId,
                                streetId: a.streetId,
                                streetName: a.streetName,
                                buildingNumber: a.buildingNumber,
                                scheduleId: a.scheduleId,
                                scheduleName: a.scheduleName,
                                submissionsTotal: a.submissionsTotal,
                                submissionsAssigned: a.submissionsAssignedHere,
                                enableAutoAssign: a.enableAutoAssign,
                                isNew: false
                            }));
                        this.originalAssignments = JSON.parse(JSON.stringify(this.assignments));
                    } catch (error) {
                        console.error('Error loading assignments:', error);
                        alert('Nie udało się załadować przypisań');
                    }
                },
                removeAssignment(buildingId, scheduleId) {
                    const index = this.assignments.findIndex(a => 
                        a.buildingId === buildingId && a.scheduleId === scheduleId
                    );
                    if (index > -1) {
                        this.assignments.splice(index, 1);
                    }
                },
                bulkRemoveAssignments() {
                    if (!confirm('Czy na pewno chcesz usunąć wszystkie wyświetlane przypisania?')) return;
                    
                    const toRemove = this.filteredAssignments.map(a => `${a.buildingId}-${a.scheduleId}`);
                    this.assignments = this.assignments.filter(a => 
                        !toRemove.includes(`${a.buildingId}-${a.scheduleId}`)
                    );
                },
                bulkEnableAutoAssign() {
                    this.filteredAssignments.forEach(a => {
                        a.enableAutoAssign = true;
                    });
                },
                bulkDisableAutoAssign() {
                    this.filteredAssignments.forEach(a => {
                        a.enableAutoAssign = false;
                    });
                },
                openAddBuildingsModal() {
                    if (!addBuildingsApp) {
                        initAddBuildingsModal();
                    }
                    addBuildingsApp.openModal(this.schedules, this.streets, this.assignments);
                },
                addNewAssignments(newAssignments) {
                    newAssignments.forEach(na => {
                        const exists = this.assignments.find(a => 
                            a.buildingId === na.buildingId && a.scheduleId === na.scheduleId
                        );
                        if (!exists) {
                            this.assignments.push(na);
                        }
                    });
                },
                async saveAssignments() {
                    this.saving = true;
                    try {
                        // Open agenda assignment modal
                        await this.openAgendaAssignmentModal();
                    } catch (error) {
                        console.error('Error:', error);
                        this.saving = false;
                    }
                },
                async openAgendaAssignmentModal() {
                    this.agendaAssignmentLoading = true;
                    this.selectedAgendaId = null;
                    this.sendEmailsToAssigned = false;
                    this.deassignUnassigned = false;
                    
                    if (!agendaModal) {
                        agendaModal = document.getElementById('agenda-assignment-modal');
                    }
                    agendaModal.showModal();
                    
                    try {
                        const agendasResponse = await fetch(`/api/agenda/day/${this.dayId}`);
                        if (!agendasResponse.ok) throw new Error('Failed to fetch agendas');
                        
                        const agendas = await agendasResponse.json();
                        
                        this.availableAgendas = agendas.map(a => ({
                            id: a.id,
                            priestName: a.priest ? a.priest.displayName : null,
                            ministerNames: a.ministers ? a.ministers.map(m => m.displayName) : [],
                            visitsCount: a.visitsCount || 0,
                            startHour: a.startHourOverride || '08:00',
                            endHour: a.endHourOverride || '16:00'
                        }));
                        
                        if (this.availableAgendas.length > 0) {
                            this.selectedAgendaId = this.availableAgendas[0].id;
                        } else {
                            this.selectedAgendaId = -1;
                        }
                    } catch (error) {
                        console.error('Error loading agendas:', error);
                        alert('Nie udało się pobrać listy agend');
                        this.closeAgendaModal();
                        this.saving = false;
                    } finally {
                        this.agendaAssignmentLoading = false;
                    }
                },
                closeAgendaModal() {
                    if (agendaModal) {
                        agendaModal.close();
                    }
                    this.assignmentSaving = false;
                    this.saving = false;
                },
                async skipAssignmentAndSave() {
                    await this.performSave(null, false);
                },
                async confirmAgendaAssignment() {
                    if (this.selectedAgendaId === null) return;
                    await this.performSave(this.selectedAgendaId, true);
                },
                async performSave(agendaId, shouldAssignToAgenda) {
                    this.assignmentSaving = true;
                    
                    try {
                        const payload = {
                            dayId: this.dayId,
                            assignments: this.assignments.map(a => ({
                                buildingId: a.buildingId,
                                scheduleId: a.scheduleId,
                                enableAutoAssign: a.enableAutoAssign
                            }))
                        };
                        
                        if (shouldAssignToAgenda) {
                            payload.agendaId = agendaId;
                        }
                        
                        if (this.deassignUnassigned) {
                            payload.unassignNotMatchingVisits = true;
                        }
                        
                        if (this.sendEmailsToAssigned) {
                            payload.sendEmails = true;
                        }
                        
                        const response = await fetch('/api/Calendar/update-assignments', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (!response.ok) throw new Error('Failed to save assignments');
                        
                        if (agendaModal) agendaModal.close();
                        this.closeMainModal();
                        window.location.reload();
                    } catch (error) {
                        console.error('Error saving assignments:', error);
                        alert('Nie udało się zapisać przypisań');
                    } finally {
                        this.assignmentSaving = false;
                        this.saving = false;
                    }
                },
                closeMainModal() {
                    if (mainModal) {
                        mainModal.close();
                    }
                },
                declinateWord(count, singular, pluralFew, pluralMany) {
                    window.declinateWord(count, singular, pluralFew, pluralMany);
                },
            }
        });

        mountedApp = app.mount('#assign-buildings-app');
    };

    window.initAddBuildingsModal = function() {
        if (addBuildingsApp) return;

        const { createApp } = Vue;
        const dayId = @Model;

        const app = createApp({
            data() {
                return {
                    dayId: dayId,
                    schedules: [],
                    streets: [],
                    allBuildings: [],
                    existingAssignments: [],
                    
                    // Filters
                    addFilterScheduleId: null,
                    addFilterStreetId: null,
                    addFilterStatus: 'all',
                    addFilterParity: null,
                    addSort: 'street',
                    
                    // Selection
                    selectedBuildingsForAdd: [],
                    
                    // Loading
                    addBuildingsLoading: false,
                    
                    // Stats height for dynamic padding
                    statsHeight: 0
                };
            },
            mounted() {
                registerVueApp("add-buildings-app");
                addModal = document.getElementById('add-buildings-modal');
                this.$nextTick(() => {
                    this.updateStatsHeight();
                });
            },
            watch: {
                hasFiltersApplied() {
                    this.$nextTick(() => {
                        this.updateStatsHeight();
                    });
                }
            },
            computed: {
                filteredBuildingsForAdd() {
                    let filtered = this.allBuildings;
                    
                    if (this.addFilterScheduleId) {
                        filtered = filtered.filter(b => b.scheduleId === this.addFilterScheduleId);
                    }
                    
                    if (this.addFilterStreetId) {
                        filtered = filtered.filter(b => b.streetId === this.addFilterStreetId);
                    }
                    
                    if (this.addFilterStatus === 'unassigned') {
                        filtered = filtered.filter(b => !b.isAssignedToThisDay);
                    }
                    
                    // Parity filter
                    if (this.addFilterParity === 'even') {
                        filtered = filtered.filter(b => {
                            const num = parseInt(b.buildingNumber) || 0;
                            return num % 2 === 0;
                        });
                    } else if (this.addFilterParity === 'odd') {
                        filtered = filtered.filter(b => {
                            const num = parseInt(b.buildingNumber) || 0;
                            return num % 2 !== 0;
                        });
                    }
                    // null = wszystkie (brak filtra)
                    
                    // Sort
                    if (this.addSort === 'street') {
                        filtered.sort((a, b) => a.streetName.localeCompare(b.streetName) || a.buildingNumber.localeCompare(b.buildingNumber));
                    } else if (this.addSort === 'building') {
                        filtered.sort((a, b) => {
                            const aNum = parseInt(a.buildingNumber) || 0;
                            const bNum = parseInt(b.buildingNumber) || 0;
                            return aNum - bNum;
                        });
                    } else if (this.addSort === 'submissions') {
                        filtered.sort((a, b) => b.submissionsTotal - a.submissionsTotal);
                    }
                    
                    return filtered;
                },
                hasFiltersApplied() {
                    return this.addFilterStreetId !== null || this.addFilterStatus !== 'all' || this.addFilterParity !== null;
                },
                // Wyświetlane: nieprzypisane zgłoszenia z wyświetlanych bram (bez przypisanych tutaj)
                displayedSubmissionsCount() {
                    return this.filteredBuildingsForAdd
                        .filter(b => !this.isAlreadyAssigned(b))
                        .reduce((sum, b) => sum + b.submissionsUnassigned, 0);
                },
                // Zaznaczone widoczne: nieprzypisane zgłoszenia z wyświetlanych i zaznaczonych bram (bez przypisanych tutaj)
                selectedVisibleSubmissionsCount() {
                    const selectedKeys = new Set(this.selectedBuildingsForAdd);
                    return this.filteredBuildingsForAdd
                        .filter(b => !this.isAlreadyAssigned(b) && selectedKeys.has(`${b.buildingId}-${b.scheduleId}`))
                        .reduce((sum, b) => sum + b.submissionsUnassigned, 0);
                },
                // Wszystkie: wszystkie zgłoszenia (przypisane na dziś + zaznaczone teraz nieprzypisane)
                allSubmissionsCount() {
                    // Zgłoszenia z przypisanych na dziś
                    const assignedToday = this.existingAssignments.reduce((sum, a) => sum + a.submissionsTotal, 0);
                    
                    // Zgłoszenia z nowo zaznaczonych (nieprzypisane)
                    const selectedKeys = new Set(this.selectedBuildingsForAdd);
                    const newSelected = this.allBuildings
                        .filter(b => !this.isAlreadyAssigned(b) && selectedKeys.has(`${b.buildingId}-${b.scheduleId}`))
                        .reduce((sum, b) => sum + b.submissionsUnassigned, 0);
                    
                    return assignedToday + newSelected;
                },
                // Liczba nowo zaznaczonych budynków (bez przypisanych)
                selectedNewBuildingsCount() {
                    const selectedKeys = new Set(this.selectedBuildingsForAdd);
                    return this.allBuildings
                        .filter(b => !this.isAlreadyAssigned(b) && selectedKeys.has(`${b.buildingId}-${b.scheduleId}`))
                        .length;
                },
                // Zgłoszenia z nowo zaznaczonych budynków (bez przypisanych)
                selectedNewSubmissionsCount() {
                    const selectedKeys = new Set(this.selectedBuildingsForAdd);
                    return this.allBuildings
                        .filter(b => !this.isAlreadyAssigned(b) && selectedKeys.has(`${b.buildingId}-${b.scheduleId}`))
                        .reduce((sum, b) => sum + b.submissionsUnassigned, 0);
                }
            },
            methods: {
                isAlreadyAssigned(building) {
                    return this.existingAssignments.some(a => 
                        a.buildingId === building.buildingId && a.scheduleId === building.scheduleId
                    );
                },
                async openModal(schedules, streets, existingAssignments) {
                    this.schedules = schedules;
                    this.streets = streets;
                    this.existingAssignments = existingAssignments;
                    this.selectedBuildingsForAdd = [];
                    
                    if (this.schedules.length > 0) {
                        this.addFilterScheduleId = this.schedules[0].id;
                    }
                    
                    addModal.showModal();
                    await this.loadAllBuildings();
                    
                    this.$nextTick(() => {
                        this.updateStatsHeight();
                    });
                },
                async loadAllBuildings() {
                    this.addBuildingsLoading = true;
                    try {
                        const response = await fetch(`/api/Calendar/day-buildings?dayId=${this.dayId}`);
                        if (!response.ok) throw new Error('Failed to load buildings');
                        this.allBuildings = await response.json();
                    } catch (error) {
                        console.error('Error loading buildings:', error);
                        alert('Nie udało się załadować budynków');
                    } finally {
                        this.addBuildingsLoading = false;
                    }
                },
                toggleBuildingSelection(building) {
                    // Nie pozwalaj na odznaczanie budynków już przypisanych
                    if (this.isAlreadyAssigned(building)) {
                        return;
                    }
                    
                    const key = `${building.buildingId}-${building.scheduleId}`;
                    const index = this.selectedBuildingsForAdd.indexOf(key);
                    if (index > -1) {
                        this.selectedBuildingsForAdd.splice(index, 1);
                    } else {
                        this.selectedBuildingsForAdd.push(key);
                    }
                },
                selectAllFiltered() {
                    this.filteredBuildingsForAdd.forEach(building => {
                        // Pomiń budynki już przypisane
                        if (this.isAlreadyAssigned(building)) {
                            return;
                        }
                        
                        const key = `${building.buildingId}-${building.scheduleId}`;
                        if (!this.selectedBuildingsForAdd.includes(key)) {
                            this.selectedBuildingsForAdd.push(key);
                        }
                    });
                },
                deselectAllFiltered() {
                    const filteredKeys = this.filteredBuildingsForAdd
                        .filter(b => !this.isAlreadyAssigned(b))
                        .map(b => `${b.buildingId}-${b.scheduleId}`);
                    this.selectedBuildingsForAdd = this.selectedBuildingsForAdd.filter(key => !filteredKeys.includes(key));
                },
                deselectAll() {
                    this.selectedBuildingsForAdd = [];
                },
                confirmAddBuildings() {
                    const newAssignments = this.allBuildings
                        .filter(b => this.selectedBuildingsForAdd.includes(`${b.buildingId}-${b.scheduleId}`))
                        .map(b => ({
                            buildingId: b.buildingId,
                            streetId: b.streetId,
                            streetName: b.streetName,
                            buildingNumber: b.buildingNumber,
                            scheduleId: b.scheduleId,
                            scheduleName: b.scheduleName,
                            submissionsTotal: b.submissionsTotal,
                            submissionsAssigned: b.submissionsAssignedHere,
                            enableAutoAssign: false,
                            isNew: true
                        }));
                    
                    mountedApp.addNewAssignments(newAssignments);
                    this.closeAddBuildingsModal();
                },
                closeAddBuildingsModal() {
                    if (addModal) {
                        addModal.close();
                    }
                },
                toggleParity(value) {
                    if (this.addFilterParity === value) {
                        this.addFilterParity = null; // Odkliknięcie
                    } else {
                        this.addFilterParity = value; // Kliknięcie
                    }
                },
                updateStatsHeight() {
                    if (this.$refs.statsContainer) {
                        this.statsHeight = this.$refs.statsContainer.offsetHeight;
                    }
                },
                declinateWord(count, singular, pluralFew, pluralMany) {
                    window.declinateWord(count, singular, pluralFew, pluralMany);
                },
            }
        });

        addBuildingsApp = app.mount('#add-buildings-app');
    };

    window.openAssignmentModal = async function() {
        if (!mainModal) {
            mainModal = document.getElementById('assign-buildings-modal');
        }
        mainModal.showModal();
        await mountedApp.loadModalData();
    };
</script>
